<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙƒØªØ¨Ø© Ziad Aldriny 2026 - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
    
    <link rel="icon" type="image/png" href="favicon.png">
    
    <meta property="og:title" content="Ù…ÙƒØªØ¨Ø© Ziad Aldriny 2026">
    <meta property="og:description" content="Ù…ÙƒØªØ¨ØªÙŠ Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø© Ù„Ù„ÙƒØªØ¨ ÙˆØ§Ù„Ù…Ù„Ø®ØµØ§Øª">
    <meta property="og:image" content="social-preview.png">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    
    <!-- Ø®Ø·ÙˆØ· Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;600;900&display=swap" rel="stylesheet">
    <!-- Ø®Ø·ÙˆØ· Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;800&family=Great+Vibes&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        :root {
            --primary: #00d4ff; --bg: #050505; --card: #0d1117;
            --text: #ffffff; --border: rgba(255,255,255,0.1); --danger: #ff4d4d;
            --success: #2ecc71;
        }
        [data-theme="light"] { --bg: #f0f2f5; --card: #ffffff; --text: #1a1a1a; --primary: #007bff; --border: rgba(0,0,0,0.1); }
        [data-theme="purple"] { --bg: #1a0b2e; --card: #2d1454; --text: #ffffff; --primary: #bc13fe; --border: rgba(255,255,255,0.1); }
        [data-theme="forest"] { --bg: #0a1a0a; --card: #142d14; --text: #ffffff; --primary: #2ecc71; --border: rgba(255,255,255,0.1); }
        [data-theme="sunset"] { --bg: #1a0f0f; --card: #2d1414; --text: #ffffff; --primary: #e67e22; --border: rgba(255,255,255,0.1); }
        [data-theme="gold"] { --bg: #11110a; --card: #222214; --text: #ffffff; --primary: #f1c40f; --border: rgba(255,255,255,0.1); }
        
        * { box-sizing: border-box; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); color: var(--text); margin: 0; min-height: 100vh; overflow-x: hidden; }
        
        /* ====================== Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Splash Screen) ====================== */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #050505;
            overflow: hidden;
        }
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #1a1a24 0%, #050505 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            transition: opacity 0.8s ease, visibility 0.8s ease;
        }
        .gold-text {
            background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0px 4px 15px rgba(212, 175, 55, 0.3);
        }
        .top-badge {
            font-family: 'Cinzel', serif;
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 25px;
            animation: fadeInDown 1.2s ease forwards;
            opacity: 0;
        }
        .logo-container {
            width: 200px; 
            height: 200px;
            border-radius: 50%;
            padding: 5px;
            background: linear-gradient(135deg, #bf953f, #fcf6ba, #aa771c);
            box-shadow: 0 0 40px rgba(212, 175, 55, 0.5);
            margin-bottom: 25px;
            opacity: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 1s ease 0.3s forwards, pulseGlow 2s infinite alternate 1.3s;
        }
        .logo-container img {
            width: 96%;
            height: 96%;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #050505;
        }
        .library-name {
            font-family: 'Cinzel', serif;
            font-size: 3rem;
            margin: 0;
            letter-spacing: 4px;
            text-transform: uppercase;
            opacity: 0;
            animation: fadeInUp 1.2s ease 0.6s forwards;
        }
        .footer-text {
            position: absolute;
            bottom: 50px;
            font-family: 'Great Vibes', cursive;
            font-size: 1.6rem;
            color: #d4af37;
            opacity: 0;
            animation: fadeIn 1.2s ease 1s forwards;
        }
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-40px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        @keyframes pulseGlow {
            from { box-shadow: 0 0 20px rgba(212, 175, 55, 0.4); transform: scale(1); }
            to { box-shadow: 0 0 50px rgba(212, 175, 55, 0.8); transform: scale(1.03); }
        }
        .hide-splash {
            opacity: 0 !important;
            visibility: hidden !important;
        }
        /* ====================== Ù†Ù‡Ø§ÙŠØ© Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ====================== */

        .floating-badge {
            position: fixed; bottom: 20px; right: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 900;
            font-size: 1.1rem;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
            z-index: 9999;
            animation: pulse 2s infinite, float 3s ease-in-out infinite;
            display: none;
        }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0,212,255,0.4); } 70% { box-shadow: 0 0 0 15px rgba(0,212,255,0); } 100% { box-shadow: 0 0 0 0 rgba(0,212,255,0); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        #loader { position: fixed; inset: 0; background: linear-gradient(135deg, #000000, #001f3f); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; opacity: 1; transition: opacity 1s ease-out; }
        #loader.fade-out { opacity: 0; }
        .loader-icon-container { position: relative; animation: fadeInUp 1s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .loader-logo { width: 220px; height: 220px; border-radius: 30px; border: 3px solid var(--primary); box-shadow: 0 0 30px var(--primary), 0 0 60px rgba(0, 212, 255, 0.5); object-fit: cover; animation: pulseGlow 2s infinite; }
        @keyframes pulseGlow { 0% { box-shadow: 0 0 30px var(--primary), 0 0 60px rgba(0, 212, 255, 0.5); } 50% { box-shadow: 0 0 50px var(--primary), 0 0 80px rgba(0, 212, 255, 0.7); } 100% { box-shadow: 0 0 30px var(--primary), 0 0 60px rgba(0, 212, 255, 0.5); } }
        .loader-badge { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2.5rem; font-weight: 900; color: var(--primary); text-shadow: 0 0 15px var(--primary), 0 0 30px rgba(0, 212, 255, 0.7); animation: scalePulse 1.5s infinite; }
        @keyframes scalePulse { 0%, 100% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.1); } }
        .loader-title { font-size: 3rem; font-weight: 900; text-shadow: 0 0 20px var(--primary), 0 0 40px rgba(0, 212, 255, 0.5); margin: 30px 0 10px; letter-spacing: 2px; animation: fadeInUp 1s ease-out 0.5s forwards; opacity: 0; }
        .loader-subtitle { font-size: 1rem; font-style: italic; color: #ccc; text-shadow: 0 0 10px rgba(255,255,255,0.5); font-family: 'Cairo'; opacity: 0; animation: fadeInUp 1s ease-out 1s forwards; }
        
        .header { padding: 30px 0; position: relative; display: flex; justify-content: space-between; align-items: center; }
        #sidebarToggle { position: absolute; top: 15px; left: 15px; z-index: 100; font-size: 1.5rem; background: none; border: none; color: var(--primary); cursor: pointer; display: none; }
        .user-logo { width: 150px; height: 150px; border-radius: 50%; border: 2px solid var(--primary); box-shadow: 0 0 20px var(--primary); object-fit: cover; }
        .ziad-name { font-size: 2rem; font-weight: 900; text-shadow: 0 0 15px var(--primary); margin: 0 15px; animation: lightning 1s infinite alternate; }
        @keyframes lightning {
            0% { text-shadow: 0 0 15px var(--primary), 0 0 30px rgba(0, 212, 255, 0.7); }
            50% { text-shadow: 0 0 25px #fff, 0 0 50px rgba(255, 255, 255, 0.8); }
            100% { text-shadow: 0 0 15px var(--primary), 0 0 30px rgba(0, 212, 255, 0.7); }
        }
        .header-logo-container { 
            display: flex; 
            align-items: center; 
            justify-content: flex-start; 
            flex-grow: 1; 
        }
        
        .glass-panel { background: rgba(255,255,255,0.03); backdrop-filter: blur(15px); border: 1px solid var(--border); border-radius: 25px; padding: 35px; width: 90%; max-width: 400px; margin: 40px auto; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid var(--border); background: rgba(0,0,0,0.3); color: var(--text); text-align: center; font-family: 'Cairo'; outline: none; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 10px var(--primary); }
        
        .btn { background: linear-gradient(45deg, #0056b3, var(--primary)); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: 700; cursor: pointer; width: 100%; font-size: 1rem; }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px var(--primary); }
        
        #libraryContent { display: none; padding: 20px; max-width: 1300px; margin: auto; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; gap: 15px; flex-wrap: wrap; }
        .status-chip { background: var(--card); padding: 8px 16px; border-radius: 50px; border: 1px solid var(--primary); cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; font-weight: bold; }
        .status-chip:hover { background: var(--primary); color: #000; }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; z-index: 2000; padding: 20px; backdrop-filter: blur(5px); }
        .modal-box { background: var(--card); max-width: 450px; margin: 50px auto; padding: 25px; border-radius: 25px; border: 1px solid var(--primary); }
        
        .controls { display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 12px; background: var(--card); padding: 15px; border-radius: 15px; margin-bottom: 30px; border: 1px solid var(--border); }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        
        .card { background: var(--card); border-radius: 20px; padding: 12px; border: 1px solid var(--border); position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .card:hover { transform: translateY(-10px); border-color: var(--primary); box-shadow: 0 10px 20px rgba(0,0,0,0.4); }
        .card-tag { position: absolute; top: 12px; right: 12px; background: var(--primary); color: #000; font-size: 0.7rem; padding: 4px 10px; border-radius: 8px; font-weight: 900; z-index: 5; }
        .preview { width: 100%; aspect-ratio: 3/4; border-radius: 12px; object-fit: cover; background: #111; cursor: pointer; }
        
        .title-edit { font-weight: 700; background: transparent; border: none; color: var(--primary); width: 100%; text-align: center; font-size: 1rem; margin: 12px 0 5px 0; }
        .book-meta { font-size: 0.75rem; color: #888; margin-bottom: 12px; text-align: center; }
        .book-author { text-align: center; font-size: 0.8rem; color: #aaa; margin: 5px 0; }
        .card-btns { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: auto; }
        .btn-s { padding: 10px; border-radius: 8px; border: none; font-weight: bold; font-size: 0.8rem; cursor: pointer; color: #fff; }
        
        .book-rating { color: #f1c40f; font-size: 0.9rem; margin-bottom: 5px; text-align: center; }
        .book-description { font-size: 0.8rem; color: #bbb; text-align: center; margin-bottom: 10px; height: 2.4em; overflow: hidden; }
        .book-progress { font-size: 0.8rem; color: var(--success); text-align: center; margin-bottom: 5px; }
        .book-reading-time { font-size: 0.8rem; color: #00d4ff; text-align: center; margin-bottom: 10px; }
        
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--primary); color: #000; padding: 12px 30px; border-radius: 15px; font-weight: 800; display: none; z-index: 5000; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        
        @media (max-width: 600px) {
            .grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
            .controls { grid-template-columns: 1fr; }
        }
        .footer { text-align: center; padding: 40px; color: #666; font-size: 0.9rem; font-weight: bold; }
        
        /* Sidebar */
        #sidebar {
            position: fixed; top: 0; left: 0; width: 250px; height: 100%; background: var(--card); 
            transform: translateX(-100%); transition: transform 0.3s ease; z-index: 1001;
            padding: 20px; border-right: 1px solid var(--border);
        }
        #sidebar.open { transform: translateX(0); }
        .sidebar-item { display: block; padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; }
        .sidebar-item:hover { background: var(--primary); color: #000; }
        
        /* Contact */
        .contact-btn { display: flex; align-items: center; justify-content: center; gap: 10px; background: linear-gradient(45deg, #0056b3, var(--primary)); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: 700; cursor: pointer; width: 100%; font-size: 1rem; margin-top: 10px; }
        .contact-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px var(--primary); }
        .contact-icon { font-size: 1.5rem; }
    </style>
    
    <!-- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø´ØºÙ„ -->
    <style>
        :root {
            --reader-bg: #0f0f0f;
            --toolbar-bg: rgba(20, 20, 20, 0.8);
            --accent: #ff0055;
            --text: #ffffff;
        }
        .ziad-reader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--reader-bg); z-index: 10000; font-family: 'Cairo', sans-serif;
        }
        .reader-container { height: 100%; display: flex; flex-direction: column; position: relative; }
        .reader-toolbar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 20px; background: var(--toolbar-bg); backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255,255,255,0.1); z-index: 10;
        }
        .t-section { display: flex; align-items: center; gap: 12px; }
        .t-btn { 
            background: rgba(255,255,255,0.05); border: none; color: white; 
            width: 38px; height: 38px; border-radius: 10px; cursor: pointer;
            transition: 0.3s; display: flex; align-items: center; justify-content: center;
        }
        .t-btn:hover { background: var(--accent); transform: translateY(-2px); }
        .close-btn { background: rgba(255, 0, 0, 0.2); }
        .page-info { background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 20px; font-weight: bold; border: 1px solid rgba(255,255,255,0.1); }
        .page-info input { width: 40px; background: transparent; border: none; color: var(--accent); text-align: center; font-size: 1rem; outline: none; }
        #viewer-viewport { flex: 1; overflow: auto; display: flex; justify-content: center; padding: 40px 10px; background: #1a1a1a; transition: 0.4s; }
        #canvas-wrapper { box-shadow: 0 20px 50px rgba(0,0,0,0.6); transition: transform 0.3s ease; position: relative; display: flex; }
        #canvas-left, #canvas-right { border: 1px solid rgba(255,255,255,0.1); }
        #draw-overlay { position: absolute; top: 0; left: 0; z-index: 5; cursor: crosshair; }
        .floating-actions {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); padding: 10px 25px;
            border-radius: 50px; display: flex; gap: 20px; border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); opacity: 0.5; transition: 0.3s;
        }
        .floating-actions:hover { opacity: 1; bottom: 35px; }
        .f-btn { background: transparent; border: none; color: #ddd; cursor: pointer; font-size: 0.9rem; font-family: 'Cairo'; }
        .f-btn:hover { color: var(--accent); }
        .v-sep { width: 1px; height: 20px; background: rgba(255,255,255,0.2); }
        .mode-sepia { background: #f4ecd8 !important; }
        .mode-sepia canvas { filter: sepia(0.6) contrast(1.1); }
        .mode-dark { background: #000 !important; }
        .mode-dark canvas { filter: invert(0.9) hue-rotate(180deg); }
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }
        #draw-tools { display: none; flex-direction: column; position: absolute; top: 50px; right: 20px; background: var(--toolbar-bg); padding: 10px; border-radius: 10px; }
        #draw-tools button, #draw-tools input { margin: 5px 0; }
    </style>
</head>
<body data-theme="dark">

    <!-- ====================== Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ====================== -->
    <div id="splash-screen">
        <div class="top-badge gold-text">#1</div>
        
        <div class="logo-container">
            <img src="https://i.ibb.co/Pvk3ZKMK/image.jpg" alt="Ziad Library Logo">
        </div>
        
        <h1 class="library-name gold-text">Ziad Library</h1>
        
        <div class="footer-text">Made In Aldriny</div>
    </div>
    <!-- ====================== Ù†Ù‡Ø§ÙŠØ© Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ====================== -->

    <div id="loader">
        <div class="loader-icon-container">
            <img src="favicon.png" class="loader-logo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1043/1043322.png'">
            <div class="loader-badge">#1</div>
        </div>
        <h1 class="loader-title">Ziad Library</h1>
        <p class="loader-subtitle">Made In Aldriny</p>
    </div>

    <div class="floating-badge" id="floatingBadge">Ziad # 1</div>
    
    <div class="header">
        <button id="sidebarToggle">â˜°</button>
        <div class="header-logo-container">
            <img src="favicon.png" class="user-logo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1043/1043322.png'">
            <div class="ziad-name">Ziad Library</div>
        </div>
    </div>

    <div id="sidebar">
        <div id="user-name-display" style="text-align: center; font-weight: bold; padding: 10px; color: var(--primary);"></div>
        <div class="sidebar-item" onclick="playAudio('click'); openProfile()">ğŸ‘¤ Ø£Ù†Ø§</div>
        <div class="sidebar-item" id="settingsBtn" onclick="playAudio('click'); openSettings()">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
        <div class="sidebar-item" onclick="playAudio('click'); openContact()">ğŸ“ ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</div>
        <div class="sidebar-item" onclick="playAudio('click'); openDownloadBooks()">ğŸ“š ØªÙ†Ø²ÙŠÙ„ ÙƒØªØ¨</div>
        <div class="sidebar-item" onclick="playAudio('click'); openAboutUs()">â„¹ï¸ Ù„Ù…Ø­Ø© Ø¹Ù†Ø§</div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„ÙŠØ© -->
    <div id="initialScreen" class="glass-panel" style="display:none">
        <h2 style="color:var(--primary); margin-top:0; font-size:1.8rem;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…ÙƒØªØ¨Ø© Ziad Aldriny 2026 ğŸŒ€</h2>
        <p style="margin:25px 0 35px; font-size:1.1rem; line-height:1.5;">Ø§Ø®ØªØ± ÙƒÙŠÙ ØªØ±ÙŠØ¯ Ø§Ù„Ø¨Ø¯Ø¡:</p>
        
        <button class="btn" onclick="startWithoutPassword()" style="margin-bottom:18px; background:linear-gradient(45deg,#2ecc71,#00d4ff); font-size:1.1rem; padding:16px;">
            â© Ø§Ø¨Ø¯Ø£ Ø¨Ø¯ÙˆÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±
        </button>
        
        <button class="btn" onclick="showCreatePasswordModal()" style="font-size:1.1rem; padding:16px;">
            ğŸ” Ø£Ù†Ø´Ø¦ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø¢Ù†
        </button>
        
        <p style="font-size:0.85rem; color:#888; margin-top:40px;">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù† ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª Ù…Ù† Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</p>
    </div>

    <div id="loginPage" class="glass-panel" style="display:none">
        <h2 style="color:var(--primary); margin-top:0">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ø¨Ø·Ù„ ğŸŒ€</h2>
        <input type="password" id="passIn" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn" onclick="login()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ÙƒØªØ¨Ø©</button>
        
        <button class="btn" onclick="playAudio('click'); openContact()" style="margin-top:15px; background:linear-gradient(45deg,#6f42c1,var(--primary));">ğŸ“ ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</button>
        <button class="btn" onclick="playAudio('click'); openAboutUs()" style="margin-top:10px; background:linear-gradient(45deg,#198754,var(--primary));">â„¹ï¸ Ù„Ù…Ø­Ø© Ø¹Ù†Ø§</button>
        
        <p onclick="playAudio('click'); showPage('secPage')" style="cursor:pointer; font-size:0.8rem; margin-top:20px; color:#555">Ù‡Ù„ Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</p>
    </div>

    <div id="secPage" class="glass-panel" style="display:none">
        <h3 style="color:var(--primary)">ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ù…Ø§Ù†</h3>
        <p style="font-size:0.9rem">Ù…Ø§ Ù‡Ùˆ Ø·ÙˆÙ„ÙƒØŸ</p>
        <input type="text" id="secAns" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù‡Ù†Ø§">
        <button class="btn" onclick="checkSec()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù‡ÙˆÙŠØ©</button>
        <button class="btn" style="background:transparent; color:#777; margin-top:10px" onclick="playAudio('click'); showPage('loginPage')">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div id="libraryContent">
        <div class="top-nav">
            <div style="display:flex; gap:10px">
                <div class="status-chip" onclick="playAudio('popup');" id="storageChip">ğŸ’¾ Ø§Ù„Ù…Ø³Ø§Ø­Ø©: <span id="totalStorage">0 KB</span></div>
                <div class="status-chip" onclick="playAudio('trash'); showBin()" style="border-color:var(--danger); color:var(--danger)">ğŸ—‘ï¸ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª (<span id="binCount">0</span>)</div>
            </div>
            <div style="display:flex; gap:10px">
                <button class="status-chip" style="background:#198754; color:#fff; border:none" onclick="playAudio('success'); exportData()">ğŸ“¤ ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø©</button>
                <button class="status-chip" style="background:#6f42c1; color:#fff; border:none" onclick="playAudio('click'); document.getElementById('importFile').click()">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø©</button>
                <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
            </div>
        </div>
        <div class="controls">
            <input type="text" id="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„ÙƒØªØ§Ø¨ Ø£Ùˆ Ø§Ù„ÙˆØµÙ..." oninput="render()">
            <select id="catFilter" onchange="playAudio('click'); render()">
                <option value="all">ğŸ“ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</option>
                <option value="ÙƒØªØ¨">ğŸ“š ÙƒØªØ¨</option>
                <option value="Ø±ÙˆØ§ÙŠØ§Øª">ğŸ­ Ø±ÙˆØ§ÙŠØ§Øª</option>
                <option value="Ù…Ù„Ø®ØµØ§Øª">ğŸ“ Ù…Ù„Ø®ØµØ§Øª</option>
                <option value="ÙƒØªØ¨ Ø¯Ø±Ø§Ø³ÙŠØ©">ğŸ“– ÙƒØªØ¨ Ø¯Ø±Ø§Ø³ÙŠØ©</option>
                <option value="Ø£Ø®Ø±Ù‰">âœ¨ Ø£Ø®Ø±Ù‰</option>
            </select>
            <select id="sort" onchange="playAudio('click'); render()">
                <option value="new">ğŸ•’ Ø§Ù„Ø£Ø­Ø¯Ø«</option>
                <option value="az">ğŸ”¤ Ø£Ø¨Ø¬Ø¯ÙŠ</option>
            </select>
            <button class="btn" onclick="playAudio('popup'); document.getElementById('fileIn').click()">â• Ø±ÙØ¹ PDF</button>
            <input type="file" id="fileIn" accept=".pdf" style="display:none" onchange="upload(event)">
        </div>
        <div class="grid" id="grid"></div>
    </div>

    <!-- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª -->
    <div id="settingsModal" class="modal"><div class="modal-box">
        <h4 style="color:var(--primary); margin-top:0">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª âš™ï¸</h4>
        <label>Ø§Ù„Ù…Ø¸Ù‡Ø±:</label>
        <select id="themeSelect" onchange="playAudio('click'); setTheme(this.value)">
            <option value="dark">Ø¯Ø§ÙƒÙ†</option><option value="light">ÙØ§ØªØ­</option><option value="purple">Ø¨Ù†ÙØ³Ø¬ÙŠ</option><option value="forest">Ø§Ù„ØºØ§Ø¨Ø©</option><option value="sunset">ØºØ±ÙˆØ¨ Ø§Ù„Ø´Ù…Ø³</option><option value="gold">Ø§Ù„Ø°Ù‡Ø¨ÙŠ</option>
        </select>
        <button class="btn" style="margin-top:20px" onclick="playAudio('click'); toggleLanguage()">ğŸŒ ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ© Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</button>
        <button class="btn" style="margin-top:10px" onclick="playAudio('click'); openPassChangeModal()">ğŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
        <!-- Ø²Ø± Ø§Ù„ØµÙˆØª Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
        <button class="btn" style="margin-top:10px" onclick="playAudio('click'); openSoundSettings()">ğŸ”Š Ø§Ù„ØµÙˆØª</button>
        <button class="btn" style="margin-top:10px; background:var(--danger)" onclick="playAudio('trash'); deleteAllFiles()">ğŸ—‘ï¸ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª</button>
        <button class="btn" style="background:#333; margin-top:15px" onclick="playAudio('click'); closeModals()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div></div>

    <div id="passChangeModal" class="modal"><div class="modal-box">
        <h4 style="color:var(--primary)">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù†</h4>
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</label>
        <input type="password" id="newPassInput" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©">
        <label>Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù…Ø«Ø§Ù„: Ù…Ø§ Ù‡Ùˆ Ø·ÙˆÙ„ÙƒØŸ):</label>
        <input type="text" id="newSecQuestion" placeholder="Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù†">
        <label>Ø¥Ø¬Ø§Ø¨Ø© Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù†:</label>
        <input type="text" id="newSecAnswer" placeholder="Ø¥Ø¬Ø§Ø¨Ø© Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù†">
        <button class="btn" onclick="playAudio('success'); saveNewPassAndSec()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn" style="background:#333; margin-top:10px" onclick="playAudio('click'); closeModals()">Ø¥Ù„ØºØ§Ø¡</button>
    </div></div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ -->
    <div id="createPassModal" class="modal"><div class="modal-box">
        <h4 style="color:var(--primary); margin-top:0">Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø£ÙˆÙ„ÙŠØ© ÙˆØ³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù†</h4>
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
        <input type="password" id="initPass" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ©">
        <label>Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù† (Ù…Ø«Ø§Ù„: Ù…Ø§ Ù‡Ùˆ Ø·ÙˆÙ„ÙƒØŸ):</label>
        <input type="text" id="initSecQ" placeholder="Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù†">
        <label>Ø¥Ø¬Ø§Ø¨Ø© Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù†:</label>
        <input type="text" id="initSecA" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø³Ø±ÙŠØ©">
        <button class="btn" onclick="saveInitialPass()">Ø­ÙØ¸ ÙˆØ¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø©</button>
        <button class="btn" style="background:#333; margin-top:10px" onclick="closeCreateModal()">Ø±Ø¬ÙˆØ¹</button>
    </div></div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø±ÙØ¹ Ø§Ù„ÙƒØªØ§Ø¨ (Ù…Ø­Ø¯Ø«) -->
    <div id="uploadModal" class="modal"><div class="modal-box">
        <h4 style="color:var(--primary)">Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯</h4>
        <div id="pendingFileName" style="font-size:0.8rem; color:#888; margin-bottom:10px"></div>
        
        <label>Ø§Ø³Ù… Ø§Ù„ÙƒØªØ§Ø¨:</label>
        <input type="text" id="bookTitleInput" placeholder="Ø§Ø³Ù… Ø§Ù„ÙƒØªØ§Ø¨">
        
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ù„Ù:</label>
        <input type="text" id="bookAuthorInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ù„Ù">
        
        <label>Ø§Ù„ØªØµÙ†ÙŠÙ:</label>
        <select id="selectedCat">
            <option value="ÙƒØªØ¨">ğŸ“š ÙƒØªØ¨</option>
            <option value="Ø±ÙˆØ§ÙŠØ§Øª">ğŸ­ Ø±ÙˆØ§ÙŠØ§Øª</option>
            <option value="Ù…Ù„Ø®ØµØ§Øª">ğŸ“ Ù…Ù„Ø®ØµØ§Øª</option>
            <option value="ÙƒØªØ¨ Ø¯Ø±Ø§Ø³ÙŠØ©">ğŸ“– ÙƒØªØ¨ Ø¯Ø±Ø§Ø³ÙŠØ©</option>
            <option value="Ø£Ø®Ø±Ù‰">âœ¨ Ø£Ø®Ø±Ù‰</option>
        </select>
        
        <label>ÙˆØµÙ Ø§Ù„ÙƒØªØ§Ø¨:</label>
        <input type="text" id="bookDescInput" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙØ§Ù‹ Ù…Ø®ØªØµØ±Ø§Ù‹">
        
        <label>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</label>
        <select id="bookRatingInput">
            <option value="5">â­â­â­â­â­ (Ù…Ù…ØªØ§Ø²)</option>
            <option value="4">â­â­â­â­ (Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹)</option>
            <option value="3">â­â­â­ (Ù…ØªÙˆØ³Ø·)</option>
            <option value="2">â­â­ (Ø¶Ø¹ÙŠÙ)</option>
            <option value="1">â­ (Ø³ÙŠØ¡)</option>
        </select>
        
        <button class="btn" id="confirmUploadBtn">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±ÙØ¹</button>
        <button class="btn" style="background:#333; margin-top:10px" onclick="playAudio('click'); closeModals()">Ø¥Ù„ØºØ§Ø¡</button>
    </div></div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙƒØªØ§Ø¨ -->
    <div id="editBookModal" class="modal"><div class="modal-box">
        <h4 style="color:var(--primary)">ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙƒØªØ§Ø¨</h4>
        
        <label>Ø§Ø³Ù… Ø§Ù„ÙƒØªØ§Ø¨:</label>
        <input type="text" id="editTitle" placeholder="Ø§Ø³Ù… Ø§Ù„ÙƒØªØ§Ø¨">
        
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ù„Ù:</label>
        <input type="text" id="editAuthor" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ù„Ù">
        
        <label>Ø§Ù„ØªØµÙ†ÙŠÙ:</label>
        <select id="editCat">
            <option value="ÙƒØªØ¨">ğŸ“š ÙƒØªØ¨</option>
            <option value="Ø±ÙˆØ§ÙŠØ§Øª">ğŸ­ Ø±ÙˆØ§ÙŠØ§Øª</option>
            <option value="Ù…Ù„Ø®ØµØ§Øª">ğŸ“ Ù…Ù„Ø®ØµØ§Øª</option>
            <option value="ÙƒØªØ¨ Ø¯Ø±Ø§Ø³ÙŠØ©">ğŸ“– ÙƒØªØ¨ Ø¯Ø±Ø§Ø³ÙŠØ©</option>
            <option value="Ø£Ø®Ø±Ù‰">âœ¨ Ø£Ø®Ø±Ù‰</option>
        </select>
        
        <label>ÙˆØµÙ Ø§Ù„ÙƒØªØ§Ø¨:</label>
        <input type="text" id="editDesc" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙØ§Ù‹ Ù…Ø®ØªØµØ±Ø§Ù‹">
        
        <label>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</label>
        <select id="editRating">
            <option value="5">â­â­â­â­â­ (Ù…Ù…ØªØ§Ø²)</option>
            <option value="4">â­â­â­â­ (Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹)</option>
            <option value="3">â­â­â­ (Ù…ØªÙˆØ³Ø·)</option>
            <option value="2">â­â­ (Ø¶Ø¹ÙŠÙ)</option>
            <option value="1">â­ (Ø³ÙŠØ¡)</option>
        </select>
        
        <button class="btn" onclick="playAudio('success'); saveEditBook()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        <button class="btn" style="background:#333; margin-top:10px" onclick="playAudio('click'); closeModals()">Ø¥Ù„ØºØ§Ø¡</button>
    </div></div>

    <div id="binModal" class="modal"><div class="modal-box">
        <h4 style="color:var(--danger)">Ø§Ù„Ø³Ù„Ø©</h4>
        <div id="binList"></div>
        <button class="btn" style="background:var(--danger)" onclick="emptyBin()">Ø¥ÙØ±Ø§Øº Ø§Ù„ÙƒÙ„</button>
        <button class="btn" style="background:#333; margin-top:10px" onclick="playAudio('click'); closeModals()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div></div>

    <div id="contactModal" class="modal"><div class="modal-box">
        <h4 style="color:var(--primary); margin-top:0">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ ğŸ“</h4>
        <a href="tel:01055662785" class="contact-btn"><span class="contact-icon"><i class="fas fa-phone"></i></span> Ø§ØªØµØ§Ù„</a>
        <a href="https://wa.me/01055662785" class="contact-btn"><span class="contact-icon"><i class="fab fa-whatsapp"></i></span> ÙˆØ§ØªØ³Ø§Ø¨</a>
        <a href="https://www.facebook.com/profile.php?id=61583039190517&locale=ar_AR" class="contact-btn"><span class="contact-icon"><i class="fab fa-facebook"></i></span> ÙÙŠØ³Ø¨ÙˆÙƒ</a>
        <a href="https://www.instagram.com/ziadalzoz1020/" class="contact-btn"><span class="contact-icon"><i class="fab fa-instagram"></i></span> Ø¥Ù†Ø³ØªØºØ±Ø§Ù…</a>
        <button class="btn" style="background:#333; margin-top:15px" onclick="playAudio('click'); closeModals()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div></div>

    <div id="downloadBooksModal" class="modal"><div class="modal-box">
        <h4 style="color:var(--primary); margin-top:0">ØªÙ†Ø²ÙŠÙ„ ÙƒØªØ¨ ğŸ“š</h4>
        <a href="https://www.noor-book.com/" class="contact-btn"><span class="contact-icon">ğŸ“–</span> Ù…ÙƒØªØ¨Ø© Ù†ÙˆØ±</a>
        <a href="https://www.kotobati.com/" class="contact-btn"><span class="contact-icon">ğŸ“–</span> Ù…ÙƒØªØ¨Ø© ÙƒØªÙˆØ¨Ø§ØªÙŠ</a>
        <a href="https://books-library.website/" class="contact-btn"><span class="contact-icon">ğŸ“–</span> Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¹Ø±Ø¨</a>
        <a href="https://ellibrary.moe.gov.eg/" class="contact-btn"><span class="contact-icon">ğŸ“–</span> Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙˆØ²Ø§Ø±Ø©</a>
        <button class="btn" style="background:#333; margin-top:15px" onclick="playAudio('click'); closeModals()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div></div>

    <div id="aboutUsModal" class="modal"><div class="modal-box">
        <h4 style="color:var(--primary); margin-top:0">Ù„Ù…Ø­Ø© Ø¹Ù†Ø§ â„¹ï¸</h4>
        <p style="text-align: center; font-size: 1rem; line-height: 1.5;">Ù…ÙƒØªØ¨Ø© Ziad Aldriny 2026 Ù‡ÙŠ Ù…ÙƒØªØ¨Ø© Ø±Ù‚Ù…ÙŠØ© Ù…ØªÙƒØ§Ù…Ù„Ø© ÙˆÙ…ØªØ·ÙˆØ±Ø© Ù„ØªØ®Ø²ÙŠÙ† ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© ÙˆØ§Ù„Ù…Ù„Ø®ØµØ§Øª. ØªÙ… ØªØµÙ…ÙŠÙ…Ù‡Ø§ ÙˆØªØ·ÙˆÙŠØ±Ù‡Ø§ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨ÙˆØ§Ø³Ø·Ø© Ø²ÙŠØ§Ø¯ Ø§Ù„Ø¯Ø±ÙŠÙ†ÙŠØŒ ÙˆÙ‡ÙŠ ØªÙˆÙØ± ÙˆØ§Ø¬Ù‡Ø© Ù…Ø³ØªØ®Ø¯Ù… Ø§Ø­ØªØ±Ø§ÙÙŠØ© ØªØ¯Ø¹Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŒ Ù…Ø¹ Ø®ÙŠØ§Ø±Ø§Øª Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù…Ø¸Ù‡Ø± (Ù…Ø«Ù„ Ø§Ù„Ø¯Ø§ÙƒÙ†ØŒ Ø§Ù„ÙØ§ØªØ­ØŒ Ø§Ù„Ø¨Ù†ÙØ³Ø¬ÙŠØŒ ÙˆØ§Ù„Ù…Ø²ÙŠØ¯). ØªØªÙŠØ­ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø±ÙØ¹ Ø§Ù„ÙƒØªØ¨ Ø¨ØªÙ†Ø³ÙŠÙ‚ PDFØŒ Ø¹Ø±Ø¶Ù‡Ø§ ÙÙŠ Ù…Ø´ØºÙ„ Ù…ØªÙ‚Ø¯Ù… ÙŠØ¯Ø¹Ù… Ø§Ù„ØªÙƒØ¨ÙŠØ±ØŒ Ø§Ù„ØªØµØºÙŠØ±ØŒ Ø§Ù„ØªØ¯ÙˆÙŠØ±ØŒ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©ØŒ ÙˆØ§Ù„ØªÙ†Ø²ÙŠÙ„ØŒ Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù† Ù…Ø«Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ³Ø¤Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©. ÙƒÙ…Ø§ ØªØ¯Ø¹Ù… ØªØµØ¯ÙŠØ± ÙˆØ§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŒ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª (ÙƒØªØ¨ØŒ Ø±ÙˆØ§ÙŠØ§ØªØŒ Ù…Ù„Ø®ØµØ§ØªØŒ Ø£Ø®Ø±Ù‰)ØŒ ÙˆØ§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù…. Ø§Ù„Ù…ÙƒØªØ¨Ø© Ù…Ø¨Ù†ÙŠØ© Ø¹Ù„Ù‰ ØªÙ‚Ù†ÙŠØ§Øª Ø­Ø¯ÙŠØ«Ø© Ù…Ø«Ù„ IndexedDB Ù„Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠØŒ Ù…Ù…Ø§ ÙŠØ¬Ø¹Ù„Ù‡Ø§ Ø³Ø±ÙŠØ¹Ø© ÙˆØ¢Ù…Ù†Ø© Ø¯ÙˆÙ† Ø§Ù„Ø­Ø§Ø¬Ø© Ø¥Ù„Ù‰ Ø®ÙˆØ§Ø¯Ù… Ø®Ø§Ø±Ø¬ÙŠØ©. ØªÙ‡Ø¯Ù Ø¥Ù„Ù‰ ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„Ø¯Ø±Ø§Ø³Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ø¹Ø§Ù… 2026 ÙˆÙ…Ø§ Ø¨Ø¹Ø¯Ù‡ØŒ Ù…Ø¹ Ø¯Ø¹Ù… Ù„Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ©.</p>
        <button class="btn" style="margin-top:20px" onclick="playAudio('click'); shareSite()">ğŸ“¤ Ø´Ø§Ø±Ùƒ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
        <button class="btn" style="background:#333; margin-top:15px" onclick="playAudio('click'); closeModals()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div></div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
    <div id="profileModal" class="modal"><div class="modal-box">
        <h4 style="color:var(--primary); margin-top:0">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ğŸ‘¤</h4>
        <div id="profileContent"></div>
        <button class="btn" style="background:#333; margin-top:15px" onclick="playAudio('click'); closeModals()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div></div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
    <div id="addUsernameModal" class="modal"><div class="modal-box">
        <h4 style="color:var(--primary); margin-top:0">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ</h4>
        <input type="text" id="usernameInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <button class="btn" onclick="playAudio('success'); saveUsername()">Ø­ÙØ¸</button>
        <button class="btn" style="background:#333; margin-top:10px" onclick="playAudio('click'); closeModals()">Ø¥Ù„ØºØ§Ø¡</button>
    </div></div>

    <!-- ====================== Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª Ø§Ù„Ø¬Ø¯ÙŠØ¯ ====================== -->
    <div id="soundSettingsModal" class="modal">
        <div class="modal-box">
            <h4 style="color:var(--primary); margin-top:0">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª ğŸ”Š</h4>
            
            <p style="margin-bottom:15px; font-size:1.05rem;">Ø§Ø®ØªØ± ØµÙˆØª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙƒØªØ¨Ø© (ÙŠÙØ´ØºÙ‘Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø§Ø¬Ø­ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ØµÙˆØª Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ):</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-bottom: 30px;">
                <button class="btn" onclick="selectLoginSound('engine');" style="background: linear-gradient(45deg, #00d4ff, #007bff);">ğŸš— Ù…Ø­Ø±Ùƒ Ø³ÙŠØ§Ø±Ø©<br><small>(Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ)</small></button>
                <button class="btn" onclick="selectLoginSound('rocket');" style="background: linear-gradient(45deg, #ff8800, #e67e22);">ğŸš€ ØµØ§Ø±ÙˆØ® ÙØ¶Ø§Ø¦ÙŠ</button>
                <button class="btn" onclick="selectLoginSound('magic');" style="background: linear-gradient(45deg, #bc13fe, #6f42c1);">âœ¨ ØªØ£Ø«ÙŠØ± Ø³Ø­Ø±ÙŠ</button>
                <button class="btn" onclick="selectLoginSound('cheer');" style="background: linear-gradient(45deg, #2ecc71, #27ae60);">ğŸ‘ ØªØµÙÙŠÙ‚ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±</button>
            </div>
            
            <label style="display:block; margin:15px 0 8px; font-weight:bold;">ÙƒØªÙ… Ø§Ù„ØµÙˆØª Ø§Ù„Ø¹Ø§Ù… (ÙƒÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø©):</label>
            <button class="btn" id="muteBtn" style="background:var(--danger); width:100%;" onclick="toggleMute()">ğŸ”‡ ÙƒØªÙ… Ø§Ù„ØµÙˆØª</button>
            
            <button class="btn" style="background:#333; margin-top:20px" onclick="playAudio('click'); closeModals()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div id="toast"></div>
    <div class="footer">Ø¨ÙˆØ§Ø³Ø·Ø© Ziad Library &copy; 2026</div>

    <div id="pdfModal" class="ziad-reader-overlay" style="display:none;">
        <div class="reader-container">
            <header class="reader-toolbar">
                <div class="t-section">
                    <button class="t-btn close-btn" onclick="closeReader()" title="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
                    <div class="v-sep"></div>
                    <h3 id="reader-filename">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h3>
                </div>
                <div class="t-section nav-controls">
                    <button class="t-btn" id="prev-pg">â—€</button>
                    <div class="page-info">
                        <input type="number" id="page-num-input" value="1" min="1">
                        <span>/</span>
                        <span id="total-pages">0</span>
                    </div>
                    <button class="t-btn" id="next-pg">â–¶</button>
                </div>
                <div class="t-section tools">
                    <button class="t-btn" id="z-out" title="ØªØµØºÙŠØ±">â–</button>
                    <span id="zoom-percent">100%</span>
                    <button class="t-btn" id="z-in" title="ØªÙƒØ¨ÙŠØ±">â•</button>
                    <div class="v-sep"></div>
                    <button class="t-btn" id="rotate-pdf" title="ØªØ¯ÙˆÙŠØ±">ğŸ”„</button>
                    <button class="t-btn" id="reader-theme" title="ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©">ğŸŒ“</button>
                    <button class="t-btn" id="full-scr" title="Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©">ğŸ“º</button>
                    <button class="t-btn" id="double-page-toggle" title="ÙˆØ¶Ø¹ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬Ø©">ğŸ“–</button>
                    <button class="t-btn" id="draw-toggle" title="Ø±Ø³Ù… Ø¹Ù„Ù‰ Ø§Ù„ÙƒØªØ§Ø¨">âœï¸</button>
                </div>
            </header>
            <main id="viewer-viewport" class="custom-scroll">
                <div id="canvas-wrapper">
                    <canvas id="canvas-left"></canvas>
                    <canvas id="canvas-right" style="display:none;"></canvas>
                    <canvas id="draw-overlay"></canvas>
                </div>
            </main>
            <div class="floating-actions">
                <button class="f-btn" id="auto-scroll-toggle">ğŸ–±ï¸ ØªÙ…Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
                <div class="v-sep"></div>
                <button class="f-btn" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                <button class="f-btn" id="reader-download">ğŸ“¥ ØªØ­Ù…ÙŠÙ„</button>
            </div>
            <div id="draw-tools">
                <label>Ù„ÙˆÙ†:</label><input type="color" id="draw-color" value="#ff0000">
                <label>Ø³Ù…Ùƒ:</label><input type="number" id="draw-width" value="5" min="1" max="20">
                <button class="t-btn" id="draw-eraser">ğŸ§½ Ù…Ø­Ø§ÙŠØ©</button>
                <button class="t-btn" id="draw-clear">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        
        const sounds = {
            click: "https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3",
            success: "https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3",
            trash: "https://assets.mixkit.co/active_storage/sfx/2570/2570-preview.mp3",
            error: "https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3",
            popup: "https://assets.mixkit.co/active_storage/sfx/2580/2580-preview.mp3",
            engine: "https://assets.mixkit.co/active_storage/sfx/876/876-preview.mp3",
            // Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± (ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø¨Ø£ÙŠ Ø±ÙˆØ§Ø¨Ø· mixkit Ø£Ø®Ø±Ù‰)
            rocket: "https://assets.mixkit.co/active_storage/sfx/2955/2955-preview.mp3",
            magic: "https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3",
            cheer: "https://assets.mixkit.co/active_storage/sfx/1434/1434-preview.mp3"
        };

        let db;
        let currentPass = localStorage.getItem('ziadPass') || '';
        let currentSecQuestion = localStorage.getItem('ziadSecQuestion') || 'Ù…Ø§ Ù‡Ùˆ Ø·ÙˆÙ„ÙƒØŸ';
        let currentSecAnswer = localStorage.getItem('ziadSecAnswer') || 'Ù…Ø¹Ø±ÙØ´';
        let pendingFile = null;
        let editingBookId = null;
        let userName = localStorage.getItem('userName') || '';
        let currentBookId = null;
        let readingStartTime = null;
        
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        let selectedLoginSound = localStorage.getItem('ziadLoginSound') || 'engine';
        let isMuted = localStorage.getItem('ziadMuted') === 'true';

        const init = () => {
            const theme = localStorage.getItem('ziadTheme') || 'dark';
            const lang = localStorage.getItem('ziadLang') || 'ar';
            document.body.setAttribute('data-theme', theme);
            if (lang === 'en') {
                document.documentElement.lang = 'en';
                document.documentElement.dir = 'ltr';
            }
            // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª
            selectedLoginSound = localStorage.getItem('ziadLoginSound') || 'engine';
            isMuted = localStorage.getItem('ziadMuted') === 'true';
            updateUserNameDisplay();
        };
        init();

        function updateUserNameDisplay() {
            const display = document.getElementById('user-name-display');
            if (userName) {
                display.innerText = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${userName}`;
            } else {
                display.innerText = '';
            }
        }

        function setTheme(val) {
            localStorage.setItem('ziadTheme', val);
            document.body.setAttribute('data-theme', val);
        }

        function toggleLanguage() {
            const currentLang = localStorage.getItem('ziadLang') || 'ar';
            const newLang = currentLang === 'ar' ? 'en' : 'ar';
            localStorage.setItem('ziadLang', newLang);
            if (newLang === 'en') {
                document.documentElement.lang = 'en';
                document.documentElement.dir = 'ltr';
            } else {
                document.documentElement.lang = 'ar';
                document.documentElement.dir = 'rtl';
            }
            location.reload();
        }

        function openSettings() { playAudio('popup'); document.getElementById('settingsModal').style.display='block'; }
        function openContact() { playAudio('popup'); document.getElementById('contactModal').style.display='block'; }
        function openDownloadBooks() { playAudio('popup'); document.getElementById('downloadBooksModal').style.display='block'; }
        function openAboutUs() { playAudio('popup'); document.getElementById('aboutUsModal').style.display='block'; }
        function shareSite() {
            if (navigator.share) {
                navigator.share({
                    title: 'Ù…ÙƒØªØ¨Ø© Ziad Aldriny 2026',
                    text: 'Ø§ÙƒØªØ´Ù Ù…ÙƒØªØ¨Ø© Ø±Ù‚Ù…ÙŠØ© Ù…ØªÙƒØ§Ù…Ù„Ø© Ù„Ù„ÙƒØªØ¨ ÙˆØ§Ù„Ù…Ù„Ø®ØµØ§Øª!',
                    url: 'https://ziadalzoz1020-cpu.github.io/my-library-zi/'
                }).then(() => showToast('âœ… ØªÙ… Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©'))
                .catch(() => showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©'));
            } else {
                showToast('âŒ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­');
            }
        }
        function openPassChangeModal() { document.getElementById('passChangeModal').style.display = 'block'; }
        function saveNewPassAndSec() {
            const np = document.getElementById('newPassInput').value.trim();
            const nsq = document.getElementById('newSecQuestion').value.trim();
            const nsa = document.getElementById('newSecAnswer').value.trim();
            if(np && nsq && nsa) {
                localStorage.setItem('ziadPass', np);
                localStorage.setItem('ziadSecQuestion', nsq);
                localStorage.setItem('ziadSecAnswer', nsa);
                currentPass = np;
                currentSecQuestion = nsq;
                currentSecAnswer = nsa;
                showToast("âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù†");
                document.getElementById('newPassInput').value = '';
                document.getElementById('newSecQuestion').value = '';
                document.getElementById('newSecAnswer').value = '';
                closeModals();
            } else {
                showToast("âŒ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
            }
        }
        function deleteAllFiles() {
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§ØªØŸ")) {
                db.transaction("books", "readwrite").objectStore("books").clear().onsuccess = () => {
                    db.transaction("bin", "readwrite").objectStore("bin").clear().onsuccess = () => {
                        render(); updateStats(); showToast("ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª");
                    };
                };
            }
        }

        // ====================== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ======================
        function openSoundSettings() {
            playAudio('click');
            const modal = document.getElementById('soundSettingsModal');
            modal.style.display = 'block';
            // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø²Ø± Ø§Ù„ÙƒØªÙ…
            const muteBtn = document.getElementById('muteBtn');
            muteBtn.innerText = isMuted ? 'ğŸ”Š Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒØªÙ…' : 'ğŸ”‡ ÙƒØªÙ… Ø§Ù„ØµÙˆØª';
        }

        function getSoundName(key) {
            const names = {
                engine: 'Ù…Ø­Ø±Ùƒ Ø³ÙŠØ§Ø±Ø©',
                rocket: 'ØµØ§Ø±ÙˆØ® ÙØ¶Ø§Ø¦ÙŠ',
                magic: 'ØªØ£Ø«ÙŠØ± Ø³Ø­Ø±ÙŠ',
                cheer: 'ØªØµÙÙŠÙ‚ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±'
            };
            return names[key] || key;
        }

        function selectLoginSound(key) {
            if (!sounds[key]) return;
            selectedLoginSound = key;
            localStorage.setItem('ziadLoginSound', key);
            showToast(`âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØª: ${getSoundName(key)}`);
            // ØªØ´ØºÙŠÙ„ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØª (Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙƒØªÙˆÙ…Ø§Ù‹)
            if (!isMuted) {
                const audio = new Audio(sounds[key]);
                audio.volume = 0.5;
                audio.play().catch(() => {});
            }
        }

        function toggleMute() {
            isMuted = !isMuted;
            localStorage.setItem('ziadMuted', isMuted);
            const muteBtn = document.getElementById('muteBtn');
            if (muteBtn) muteBtn.innerText = isMuted ? 'ğŸ”Š Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒØªÙ…' : 'ğŸ”‡ ÙƒØªÙ… Ø§Ù„ØµÙˆØª';
            showToast(isMuted ? 'ğŸ”‡ ØªÙ… ÙƒØªÙ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙˆØ§Øª' : 'ğŸ”Š ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª');
        }

        // ====================== Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© ======================
        function handleInitialScreen() {
            const initialized = localStorage.getItem('ziadInitialized');
            if (!initialized) {
                document.getElementById('initialScreen').style.display = 'block';
            } else {
                if (currentPass === '') {
                    showPage('libraryContent');
                    render();
                } else {
                    showPage('loginPage');
                }
            }
        }

        function startWithoutPassword() {
            localStorage.setItem('ziadPass', '');
            localStorage.setItem('ziadInitialized', 'true');
            currentPass = '';
            document.getElementById('initialScreen').style.display = 'none';
            playAudio('success');
            showPage('libraryContent');
            render();
            showToast('âœ… ØªÙ… Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø¯ÙˆÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.');
        }

        function showCreatePasswordModal() {
            document.getElementById('initialScreen').style.display = 'none';
            document.getElementById('createPassModal').style.display = 'block';
            document.getElementById('initPass').value = '';
            document.getElementById('initSecQ').value = '';
            document.getElementById('initSecA').value = '';
        }

        function saveInitialPass() {
            const pass = document.getElementById('initPass').value.trim();
            const q = document.getElementById('initSecQ').value.trim();
            const a = document.getElementById('initSecA').value.trim();
            if (pass.length < 1 || q.length < 1 || a.length < 1) {
                showToast("âŒ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
                return;
            }
            localStorage.setItem('ziadPass', pass);
            localStorage.setItem('ziadSecQuestion', q);
            localStorage.setItem('ziadSecAnswer', a);
            localStorage.setItem('ziadInitialized', 'true');
            currentPass = pass;
            currentSecQuestion = q;
            currentSecAnswer = a;
            document.getElementById('createPassModal').style.display = 'none';
            playAudio('success');
            showPage('libraryContent');
            render();
            showToast("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­!");
        }

        function closeCreateModal() {
            document.getElementById('createPassModal').style.display = 'none';
            document.getElementById('initialScreen').style.display = 'block';
        }

        const req = indexedDB.open("Ziad_Final_2026", 4);
        req.onupgradeneeded = (e) => {
            const d = e.target.result;
            if (!d.objectStoreNames.contains('books')) {
                d.createObjectStore("books", {keyPath: "id", autoIncrement: true});
            }
            if (!d.objectStoreNames.contains('bin')) {
                d.createObjectStore("bin", {keyPath: "id", autoIncrement: true});
            }
        };
        req.onsuccess = (e) => { 
            db = e.target.result; 
            updateStats();
            setTimeout(() => {
                document.getElementById('loader').classList.add('fade-out');
                setTimeout(() => {
                    document.getElementById('loader').style.display='none';
                    handleInitialScreen();
                }, 1000);
            }, 2000);
        };

        function showToast(m) {
            const t = document.getElementById('toast'); t.innerText = m;
            t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 3000);
        }

        function showPage(id) {
            ['loginPage', 'secPage', 'libraryContent', 'initialScreen'].forEach(p => {
                const el = document.getElementById(p);
                if (el) el.style.display = 'none';
            });
            const target = document.getElementById(id);
            if (target) target.style.display = 'block';
            
            const fBadge = document.getElementById('floatingBadge');
            const sBtn = document.getElementById('sidebarToggle');
            if (id === 'libraryContent') { 
                fBadge.style.display = 'block'; 
                sBtn.style.display = 'block'; 
            } else { 
                fBadge.style.display = 'none'; 
                sBtn.style.display = 'none'; 
            }
        }

        function login() {
            if(document.getElementById('passIn').value === currentPass) { 
                playAudio('engine'); // Ø³ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø®ØªØ§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                showPage('libraryContent'); 
                render(); 
            } else {
                playAudio('error');
                showToast("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø·Ø£");
            }
        }

        function checkSec() {
            if(document.getElementById('secAns').value === currentSecAnswer) {
                playAudio('engine');
                showPage('libraryContent'); 
                showToast("Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ù‡Ùˆ: " + currentPass); 
                render();
            } else {
                playAudio('error');
                showToast("âš ï¸ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø·Ø£");
            }
        }

        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }

        function upload(e) {
            pendingFile = e.target.files[0];
            if(!pendingFile) return;
            playAudio('popup');
            document.getElementById('pendingFileName').innerText = pendingFile.name;
            document.getElementById('bookTitleInput').value = pendingFile.name.replace(/\.pdf$/i, '');
            document.getElementById('bookAuthorInput').value = '';
            document.getElementById('uploadModal').style.display = 'block';
        }

        async function getPdfInfo(dataUrl) {
            try {
                const pdf = await pdfjsLib.getDocument(dataUrl).promise;
                const numPages = pdf.numPages;
                const page = await pdf.getPage(1);
                const view = page.getViewport({scale: 0.3});
                const canv = document.createElement('canvas');
                canv.width = view.width;
                canv.height = view.height;
                await page.render({canvasContext: canv.getContext('2d'), viewport: view}).promise;
                return {
                    thumb: canv.toDataURL('image/jpeg', 0.6),
                    numPages: numPages
                };
            } catch(e) {
                console.error("PDF info error:", e);
                return {thumb: '', numPages: 0};
            }
        }

        document.getElementById('confirmUploadBtn').onclick = async () => {
            const cat = document.getElementById('selectedCat').value;
            const desc = document.getElementById('bookDescInput').value || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ";
            const rating = document.getElementById('bookRatingInput').value;
            const title = document.getElementById('bookTitleInput').value.trim() || pendingFile.name.replace(/\.pdf$/i, '');
            const author = document.getElementById('bookAuthorInput').value.trim() || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            const file = pendingFile;
            closeModals();
            showToast("â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª PDF...");
            
            const r = new FileReader();
            r.onload = async (ev) => {
                const {thumb, numPages} = await getPdfInfo(ev.target.result);
                const tx = db.transaction("books", "readwrite");
                tx.objectStore("books").add({ 
                    name: title, 
                    author: author,
                    numPages: numPages,
                    data: ev.target.result, 
                    thumb, 
                    size: file.size, 
                    category: cat,
                    description: desc,
                    rating: rating,
                    date: new Date().toLocaleDateString('ar-EG'),
                    readCount: 0,
                    lastPage: 1,
                    progress: 0,
                    readingTime: 0
                });
                tx.oncomplete = () => { 
                    playAudio('success');
                    render(); 
                    updateStats(); 
                    showToast("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙƒØªØ§Ø¨ Ù…Ø¹ Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ù„Ù ÙˆØ¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª");
                    document.getElementById('bookDescInput').value = '';
                    document.getElementById('bookTitleInput').value = '';
                    document.getElementById('bookAuthorInput').value = '';
                };
            };
            r.readAsDataURL(file);
        };

        function render() {
            const g = document.getElementById('grid');
            const q = document.getElementById('search').value.toLowerCase();
            const s = document.getElementById('sort').value;
            const cf = document.getElementById('catFilter').value;
            g.innerHTML = "";
            const tx = db.transaction("books", "readonly");
            let books = [];
            tx.objectStore("books").openCursor().onsuccess = (e) => {
                const c = e.target.result;
                if(c) { 
                    const nameMatch = c.value.name.toLowerCase().includes(q);
                    const descMatch = c.value.description && c.value.description.toLowerCase().includes(q);
                    const authorMatch = (c.value.author || '').toLowerCase().includes(q);
                    if((nameMatch || descMatch || authorMatch) && (cf === 'all' || c.value.category === cf)) books.push(c.value); 
                    c.continue(); 
                } else {
                    books.sort((a,b) => s === 'az' ? a.name.localeCompare(b.name) : b.id - a.id);
                    books.forEach(b => {
                        const d = document.createElement('div'); d.className = 'card';
                        const stars = "â­".repeat(b.rating || 5);
                        const progress = b.progress || 0;
                        const readingTime = b.readingTime || 0;
                        d.innerHTML = `
                            <div class="card-tag">${b.category || 'ÙƒØªØ¨'}</div>
                            <img src="${b.thumb || 'https://via.placeholder.com/150'}" class="preview" onclick="playAudio('popup'); viewB(${b.id})">
                            <input class="title-edit" value="${b.name}" onchange="updateTitle(${b.id}, this.value)">
                            <div class="book-rating">${stars}</div>
                            <div class="book-author">ğŸ‘¤ ${b.author || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</div>
                            <div class="book-description">${b.description || "Ø¨Ø¯ÙˆÙ† ÙˆØµÙ"}</div>
                            <div class="book-progress">ğŸ“Š ØªÙ‚Ø¯Ù…: ${progress}%</div>
                            <div class="book-reading-time">ğŸ•’ ÙˆÙ‚Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: ${formatTime(readingTime)}</div>
                            <div class="book-meta">ğŸ“… ${b.date} | ğŸ“– ${b.numPages || '?'} ØµÙØ­Ø© | ${formatSize(b.size)}</div>
                            <div class="card-btns">
                                <button class="btn-s" style="background:var(--primary); color:#000" onclick="playAudio('popup'); viewB(${b.id})">ÙØªØ­</button>
                                <button class="btn-s" style="background:#f1c40f; color:#000" onclick="playAudio('click'); editBook(${b.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                                <button class="btn-s" style="background:#333" onclick="playAudio('click'); downB(${b.id})">ØªÙ†Ø²ÙŠÙ„</button>
                                <button class="btn-s" style="background:var(--danger)" onclick="playAudio('trash'); moveToBin(${b.id})">Ø­Ø°Ù</button>
                            </div>`;
                        g.appendChild(d);
                    });
                }
            };
        }

        let currentPdfUrl = null;

        function viewB(id) {
            db.transaction("books").objectStore("books").get(id).onsuccess = (e) => {
                const b = e.target.result;
                const blob = dataURLtoBlob(b.data);
                currentPdfUrl = URL.createObjectURL(blob);
                currentBookId = id;
                pageNum = b.lastPage || 1;
                readingStartTime = Date.now();
                openReader(currentPdfUrl, b.name);
                incrementReadCount(id);
            };
        }

        function incrementReadCount(id) {
            const tx = db.transaction("books", "readwrite");
            const store = tx.objectStore("books");
            store.get(id).onsuccess = (e) => {
                const data = e.target.result;
                data.readCount = (data.readCount || 0) + 1;
                store.put(data);
            };
        }

        function updateBookProgress(id, lastPage, numPages) {
            const tx = db.transaction("books", "readwrite");
            const store = tx.objectStore("books");
            store.get(id).onsuccess = (e) => {
                const data = e.target.result;
                data.lastPage = lastPage;
                data.progress = Math.round((lastPage / numPages) * 100);
                store.put(data);
                tx.oncomplete = () => {
                    render();
                };
            };
        }

        function updateReadingTime(id, additionalTime) {
            const tx = db.transaction("books", "readwrite");
            const store = tx.objectStore("books");
            store.get(id).onsuccess = (e) => {
                const data = e.target.result;
                data.readingTime = (data.readingTime || 0) + Math.round(additionalTime / 60000);
                store.put(data);
                tx.oncomplete = () => {
                    render();
                };
            };
        }

        function downB(id) {
            db.transaction("books").objectStore("books").get(id).onsuccess = (e) => {
                const b = e.target.result;
                const a = document.createElement('a'); a.href = b.data; a.download = b.name + ".pdf"; a.click();
            };
        }

        function updateTitle(id, val) {
            const tx = db.transaction("books", "readwrite");
            const store = tx.objectStore("books");
            store.get(id).onsuccess = (e) => {
                const data = e.target.result;
                data.name = val;
                store.put(data);
                playAudio('success');
                showToast("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…");
            };
        }

        function dataURLtoBlob(dataurl) {
            var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
            while(n--) u8arr[n] = bstr.charCodeAt(n);
            return new Blob([u8arr], {type:mime});
        }

        function moveToBin(id) {
            const tx = db.transaction(["books", "bin"], "readwrite");
            tx.objectStore("books").get(id).onsuccess = (e) => {
                tx.objectStore("bin").add(e.target.result);
                tx.objectStore("books").delete(id);
                tx.oncomplete = () => { render(); updateStats(); showToast("ØªÙ… Ø§Ù„Ù†Ù‚Ù„ Ù„Ù„Ø³Ù„Ø©"); };
            };
        }

        function showBin() {
            const list = document.getElementById('binList'); list.innerHTML = "";
            document.getElementById('binModal').style.display = 'block';
            db.transaction("bin").objectStore("bin").openCursor().onsuccess = (e) => {
                const c = e.target.result;
                if(c) {
                    const row = document.createElement('div'); row.style = "display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #333; align-items:center";
                    row.innerHTML = `<span style="font-size:0.9rem">${c.value.name}</span> <button class="btn-s" style="background:#198754; padding:5px 10px" onclick="playAudio('success'); restoreBook(${c.value.id})">Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>`;
                    list.appendChild(row); c.continue();
                }
            };
        }

        function restoreBook(id) {
            const tx = db.transaction(["books", "bin"], "readwrite");
            tx.objectStore("bin").get(id).onsuccess = (e) => {
                tx.objectStore("books").add(e.target.result);
                tx.objectStore("bin").delete(id);
                tx.oncomplete = () => { showBin(); render(); updateStats(); };
            };
        }

        function emptyBin() {
            if(confirm("Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ")) {
                playAudio('trash');
                db.transaction("bin", "readwrite").objectStore("bin").clear().onsuccess = () => {
                    closeModals(); updateStats(); showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ");
                };
            }
        }

        function updateStats() {
            let total = 0;
            const tx = db.transaction(["books", "bin"], "readonly");
            tx.objectStore("books").openCursor().onsuccess = (e) => {
                const c = e.target.result;
                if(c) { total += (c.value.size || 0); c.continue(); }
                else document.getElementById('totalStorage').innerText = formatSize(total);
            };
            tx.objectStore("bin").count().onsuccess = (e) => document.getElementById('binCount').innerText = e.target.result;
        }

        function formatSize(bytes) {
            if(!bytes) return '0 B';
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + ['B', 'KB', 'MB', 'GB'][i];
        }

        function formatTime(minutes) {
            if (minutes < 60) return minutes + ' Ø¯Ù‚ÙŠÙ‚Ø©';
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return hours + ' Ø³Ø§Ø¹Ø© ' + mins + ' Ø¯Ù‚ÙŠÙ‚Ø©';
        }

        function exportData() {
            const tx = db.transaction("books", "readonly");
            const data = [];
            tx.objectStore("books").openCursor().onsuccess = (e) => {
                const c = e.target.result;
                if(c) { data.push(c.value); c.continue(); }
                else {
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(new Blob([JSON.stringify(data)], {type: "application/json"}));
                    a.download = "Ziad_Library_Backup.json"; a.click();
                }
            };
        }

        function importData(e) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const data = JSON.parse(ev.target.result);
                const tx = db.transaction("books", "readwrite");
                data.forEach(item => {
                    if (!item.readCount) item.readCount = 0;
                    if (!item.lastPage) item.lastPage = 1;
                    if (!item.progress) item.progress = 0;
                    if (!item.readingTime) item.readingTime = 0;
                    tx.objectStore("books").add(item);
                });
                tx.oncomplete = () => { playAudio('success'); render(); updateStats(); showToast("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­"); };
            };
            reader.readAsText(e.target.files[0]);
        }

        function editBook(id) {
            editingBookId = id;
            playAudio('click');
            db.transaction("books", "readonly").objectStore("books").get(id).onsuccess = (e) => {
                const b = e.target.result;
                if (!b) return;
                document.getElementById('editTitle').value = b.name || '';
                document.getElementById('editAuthor').value = b.author || '';
                document.getElementById('editCat').value = b.category || 'ÙƒØªØ¨';
                document.getElementById('editDesc').value = b.description || '';
                document.getElementById('editRating').value = b.rating || '5';
                document.getElementById('editBookModal').style.display = 'block';
            };
        }

        function saveEditBook() {
            const title = document.getElementById('editTitle').value.trim();
            if (!title) {
                showToast("âŒ Ø§Ø³Ù… Ø§Ù„ÙƒØªØ§Ø¨ Ù…Ø·Ù„ÙˆØ¨");
                return;
            }
            const author = document.getElementById('editAuthor').value.trim() || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            const cat = document.getElementById('editCat').value;
            const desc = document.getElementById('editDesc').value.trim() || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ";
            const rating = parseInt(document.getElementById('editRating').value) || 3;

            const tx = db.transaction("books", "readwrite");
            const store = tx.objectStore("books");
            store.get(editingBookId).onsuccess = (e) => {
                let data = e.target.result;
                data.name = title;
                data.author = author;
                data.category = cat;
                data.description = desc;
                data.rating = rating;
                store.put(data);
            };
            tx.oncomplete = () => {
                closeModals();
                render();
                showToast("âœ… ØªÙ… Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„ÙƒØªØ§Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
            };
        }

        // Sidebar Toggle
        document.getElementById('sidebarToggle').onclick = () => {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        };
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.getElementById('sidebarToggle');
            if (sidebar.classList.contains('open') && !sidebar.contains(event.target) && !toggle.contains(event.target)) {
                sidebar.classList.remove('open');
            }
        });

        function openProfile() {
            if (!localStorage.getItem('profileViewed')) {
                document.getElementById('addUsernameModal').style.display = 'block';
                localStorage.setItem('profileViewed', 'true');
            } else {
                showProfileStats();
            }
        }

        function saveUsername() {
            const name = document.getElementById('usernameInput').value.trim();
            if (name) {
                localStorage.setItem('userName', name);
                userName = name;
                updateUserNameDisplay();
                closeModals();
                showProfileStats();
            } else {
                showToast("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…");
            }
        }

        function showProfileStats() {
            document.getElementById('profileModal').style.display = 'block';
            const content = document.getElementById('profileContent');
            content.innerHTML = '<p>Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...</p>';
            let bookCount = 0;
            let totalSize = 0;
            let maxReadBook = { name: '', readCount: 0 };
            let maxTimeBook = { name: '', readingTime: 0 };
            let categories = {};
            let completedBooks = 0;
            let totalPagesRead = 0;
            let totalReadCount = 0;
            let avgRating = 0;
            let avgProgress = 0;
            let totalReadingTime = 0;
            const tx = db.transaction("books", "readonly");
            tx.objectStore("books").openCursor().onsuccess = (e) => {
                const c = e.target.result;
                if (c) {
                    bookCount++;
                    totalSize += c.value.size || 0;
                    totalReadCount += c.value.readCount || 0;
                    avgRating += parseInt(c.value.rating) || 0;
                    avgProgress += c.value.progress || 0;
                    totalPagesRead += (c.value.lastPage - 1) || 0;
                    totalReadingTime += c.value.readingTime || 0;
                    if (c.value.readCount > maxReadBook.readCount) {
                        maxReadBook = { name: c.value.name, readCount: c.value.readCount };
                    }
                    if (c.value.readingTime > maxTimeBook.readingTime) {
                        maxTimeBook = { name: c.value.name, readingTime: c.value.readingTime };
                    }
                    if (c.value.progress >= 100) completedBooks++;
                    categories[c.value.category] = (categories[c.value.category] || 0) + 1;
                    c.continue();
                } else {
                    avgRating = bookCount > 0 ? (avgRating / bookCount).toFixed(1) : 0;
                    avgProgress = bookCount > 0 ? (avgProgress / bookCount).toFixed(1) : 0;
                    let catStats = '';
                    for (let cat in categories) {
                        catStats += `<li>${cat}: ${categories[cat]} ÙƒØªØ§Ø¨</li>`;
                    }
                    content.innerHTML = `
                        <p>ğŸ“š Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØªØ¨: ${bookCount}</p>
                        <p>ğŸ’¾ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${formatSize(totalSize)}</p>
                        <p>ğŸ“– Ø£ÙƒØ«Ø± ÙƒØªØ§Ø¨ Ù‚Ø±Ø§Ø¡Ø©: ${maxReadBook.name} (${maxReadBook.readCount} Ù…Ø±Ø§Øª)</p>
                        <p>ğŸ•’ Ø£ÙƒØ«Ø± ÙƒØªØ§Ø¨ ÙˆÙ‚Øª Ù‚Ø±Ø§Ø¡Ø©: ${maxTimeBook.name} (${formatTime(maxTimeBook.readingTime)})</p>
                        <p>ğŸ† Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©: ${completedBooks}</p>
                        <p>â­ Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${avgRating}</p>
                        <p>ğŸ“Š Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚Ø¯Ù…: ${avgProgress}%</p>
                        <p>ğŸ“„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©: ${totalPagesRead}</p>
                        <p>ğŸ”„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø±Ø§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: ${totalReadCount}</p>
                        <p>ğŸ•’ Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙˆÙ‚Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: ${formatTime(totalReadingTime)}</p>
                        <p>ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª:</p>
                        <ul>${catStats}</ul>
                    `;
                }
            };
        }

        // ====================== Ù…Ø´ØºÙ„ PDF ======================
        let pdfDoc = null,
            pageNum = 1,
            pageIsRendering = false,
            pageNumIsPending = null,
            scale = 1.5,
            rotation = 0,
            autoScrollIdx = null,
            doublePageMode = false,
            drawMode = false,
            isErasing = false,
            drawColor = '#ff0000',
            drawWidth = 5,
            drawingData = {};

        const canvasLeft = document.getElementById('canvas-left'),
              ctxLeft = canvasLeft.getContext('2d'),
              canvasRight = document.getElementById('canvas-right'),
              ctxRight = canvasRight.getContext('2d'),
              drawOverlay = document.getElementById('draw-overlay'),
              drawCtx = drawOverlay.getContext('2d');

        function openReader(url, title) {
            document.getElementById('pdfModal').style.display = 'block';
            document.getElementById('reader-filename').innerText = title;
            document.body.style.overflow = 'hidden';
            readingStartTime = Date.now();
            pdfjsLib.getDocument(url).promise.then(pdfDoc_ => {
                pdfDoc = pdfDoc_;
                document.getElementById('total-pages').innerText = pdfDoc.numPages;
                drawingData = {};
                renderPage(pageNum);
            });
        }

        async function renderPage(num) {
            if (pageIsRendering) {
                pageNumIsPending = num;
                return;
            }
            pageIsRendering = true;

            const page = await pdfDoc.getPage(num);
            const viewport = page.getViewport({ scale, rotation });
            canvasLeft.height = viewport.height;
            canvasLeft.width = viewport.width;
            await page.render({ canvasContext: ctxLeft, viewport }).promise;

            if (doublePageMode && num < pdfDoc.numPages) {
                const nextPage = await pdfDoc.getPage(num + 1);
                const nextViewport = nextPage.getViewport({ scale, rotation });
                canvasRight.height = nextViewport.height;
                canvasRight.width = nextViewport.width;
                canvasRight.style.display = 'block';
                await nextPage.render({ canvasContext: ctxRight, viewport: nextViewport }).promise;
            } else {
                canvasRight.style.display = 'none';
            }

            const wrapper = document.getElementById('canvas-wrapper');
            drawOverlay.width = doublePageMode ? canvasLeft.width + canvasRight.width : canvasLeft.width;
            drawOverlay.height = canvasLeft.height;
            drawOverlay.style.width = drawOverlay.width + 'px';
            drawOverlay.style.height = drawOverlay.height + 'px';

            drawCtx.clearRect(0, 0, drawOverlay.width, drawOverlay.height);
            if (drawingData[num]) {
                const img = new Image();
                img.src = drawingData[num];
                img.onload = () => drawCtx.drawImage(img, 0, 0);
            }
            if (doublePageMode && drawingData[num + 1]) {
                const img = new Image();
                img.src = drawingData[num + 1];
                img.onload = () => drawCtx.drawImage(img, canvasLeft.width, 0);
            }

            pageIsRendering = false;
            if (pageNumIsPending !== null) {
                renderPage(pageNumIsPending);
                pageNumIsPending = null;
            }
            document.getElementById('page-num-input').value = num;
        }

        document.getElementById('prev-pg').onclick = () => { 
            if (pageNum <= 1) return; 
            pageNum -= doublePageMode ? 2 : 1; 
            renderPage(pageNum); 
            updateBookProgress(currentBookId, pageNum, pdfDoc.numPages);
        };
        document.getElementById('next-pg').onclick = () => { 
            if (pageNum >= pdfDoc.numPages - (doublePageMode ? 1 : 0)) return; 
            pageNum += doublePageMode ? 2 : 1; 
            renderPage(pageNum); 
            updateBookProgress(currentBookId, pageNum, pdfDoc.numPages);
        };

        document.getElementById('z-in').onclick = () => { scale += 0.2; renderPage(pageNum); updateZoomLabel(); };
        document.getElementById('z-out').onclick = () => { if(scale <= 0.5) return; scale -= 0.2; renderPage(pageNum); updateZoomLabel(); };
        function updateZoomLabel() { document.getElementById('zoom-percent').innerText = `${Math.round(scale * 100)}%`; }

        document.getElementById('rotate-pdf').onclick = () => { rotation = (rotation + 90) % 360; renderPage(pageNum); };

        document.getElementById('full-scr').onclick = () => {
            let elem = document.getElementById('pdfModal');
            if (!document.fullscreenElement) elem.requestFullscreen();
            else document.exitFullscreen();
        };

        let themes = ['', 'mode-sepia', 'mode-dark'];
        let currentTheme = 0;
        document.getElementById('reader-theme').onclick = () => {
            currentTheme = (currentTheme + 1) % themes.length;
            document.getElementById('viewer-viewport').className = 'custom-scroll ' + themes[currentTheme];
        };

        document.getElementById('auto-scroll-toggle').onclick = function() {
            if(autoScrollIdx) {
                clearInterval(autoScrollIdx); autoScrollIdx = null;
                this.innerText = "ğŸ–±ï¸ ØªÙ…Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠ";
            } else {
                this.innerText = "ğŸ›‘ Ø¥ÙŠÙ‚Ø§Ù";
                autoScrollIdx = setInterval(() => {
                    document.getElementById('viewer-viewport').scrollTop += 1;
                }, 30);
            }
        };

        function closeReader() {
            const readingDuration = Date.now() - readingStartTime;
            updateReadingTime(currentBookId, readingDuration);
            updateBookProgress(currentBookId, pageNum, pdfDoc.numPages);
            document.getElementById('pdfModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            if(autoScrollIdx) clearInterval(autoScrollIdx);
            drawMode = false;
            document.getElementById('draw-tools').style.display = 'none';
            drawOverlay.removeEventListener('mousedown', startDrawing);
            drawOverlay.removeEventListener('mousemove', draw);
            drawOverlay.removeEventListener('mouseup', stopDrawing);
            drawOverlay.removeEventListener('mouseout', stopDrawing);
            currentBookId = null;
            readingStartTime = null;
        }

        document.getElementById('page-num-input').onchange = function() {
            let val = parseInt(this.value);
            if(val > 0 && val <= pdfDoc.numPages) { 
                pageNum = val; 
                renderPage(pageNum); 
                updateBookProgress(currentBookId, pageNum, pdfDoc.numPages);
            }
        };

        window.addEventListener('keydown', (e) => {
            if(document.getElementById('pdfModal').style.display === 'block') {
                if(e.key === 'ArrowRight') document.getElementById('next-pg').click();
                if(e.key === 'ArrowLeft') document.getElementById('prev-pg').click();
                if(e.key === '+') document.getElementById('z-in').click();
                if(e.key === '-') document.getElementById('z-out').click();
                if(e.key === 'Escape') closeReader();
            }
        });

        document.getElementById('reader-download').onclick = () => {
            if (currentPdfUrl) {
                const a = document.createElement('a');
                a.href = currentPdfUrl;
                a.download = document.getElementById('reader-filename').innerText + '.pdf';
                a.click();
            } else {
                showToast("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„");
            }
        };

        document.getElementById('double-page-toggle').onclick = () => {
            doublePageMode = !doublePageMode;
            renderPage(pageNum);
        };

        document.getElementById('draw-toggle').onclick = () => {
            drawMode = !drawMode;
            const tools = document.getElementById('draw-tools');
            tools.style.display = drawMode ? 'flex' : 'none';
            if (drawMode) {
                drawColor = document.getElementById('draw-color').value;
                drawWidth = document.getElementById('draw-width').value;
                drawOverlay.addEventListener('mousedown', startDrawing);
                drawOverlay.addEventListener('mousemove', draw);
                drawOverlay.addEventListener('mouseup', stopDrawing);
                drawOverlay.addEventListener('mouseout', stopDrawing);
            } else {
                drawOverlay.removeEventListener('mousedown', startDrawing);
                drawOverlay.removeEventListener('mousemove', draw);
                drawOverlay.removeEventListener('mouseup', stopDrawing);
                drawOverlay.removeEventListener('mouseout', stopDrawing);
            }
        };

        document.getElementById('draw-color').onchange = (e) => { drawColor = e.target.value; isErasing = false; };
        document.getElementById('draw-width').onchange = (e) => { drawWidth = e.target.value; };
        document.getElementById('draw-eraser').onclick = () => { isErasing = true; };
        document.getElementById('draw-clear').onclick = () => { 
            drawCtx.clearRect(0, 0, drawOverlay.width, drawOverlay.height); 
            delete drawingData[pageNum];
            if (doublePageMode) delete drawingData[pageNum + 1];
        };

        let drawing = false;
        let lastX = 0, lastY = 0;

        function startDrawing(e) {
            drawing = true;
            [lastX, lastY] = [e.offsetX, e.offsetY];
        }

        function draw(e) {
            if (!drawing) return;
            drawCtx.beginPath();
            drawCtx.moveTo(lastX, lastY);
            drawCtx.lineTo(e.offsetX, e.offsetY);
            drawCtx.strokeStyle = isErasing ? '#ffffff' : drawColor;
            drawCtx.lineWidth = isErasing ? 20 : drawWidth;
            drawCtx.lineCap = 'round';
            drawCtx.stroke();
            [lastX, lastY] = [e.offsetX, e.offsetY];
        }

        function stopDrawing() {
            if (drawing) {
                drawing = false;
                drawingData[pageNum] = drawOverlay.toDataURL();
                if (doublePageMode) {
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = canvasRight.width;
                    tempCanvas.height = canvasRight.height;
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCtx.drawImage(drawOverlay, canvasLeft.width, 0, canvasRight.width, canvasRight.height, 0, 0, canvasRight.width, canvasRight.height);
                    drawingData[pageNum + 1] = tempCanvas.toDataURL();
                }
            }
        }

        // ====================== Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø­Ø¯Ø«Ø© (Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„ÙƒØªÙ… ÙˆØ§Ù„ØµÙˆØª Ø§Ù„Ù…Ø®ØªØ§Ø±) ======================
        function playAudio(type) {
            if (isMuted) return;
            let url = sounds[type];
            if (type === 'engine') {
                url = sounds[selectedLoginSound];
            }
            if (!url) return;
            const audio = new Audio(url);
            audio.volume = 0.5;
            audio.play().catch(e => console.log("Audio blocked"));
        }

        // ====================== Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© - Ø¥Ø®ÙØ§Ø¡ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†Ù ======================
        window.addEventListener('load', () => {
            setTimeout(() => {
                const splash = document.getElementById('splash-screen');
                if (splash) {
                    splash.classList.add('hide-splash');
                    document.body.style.overflow = 'auto';
                }
            }, 3000);
        });
    </script>
</body>
</html>